name: "Continuous Integration"
on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - run: npm install
      - run: npm run all
  test: # make sure the action works on a clean machine without building
    runs-on: ubuntu-latest
    strategy:
      matrix:
        show_differences:
          - true
          - false
        show_merge_commits:
          - true
          - false
        repo:
          - owner: NixOS
            repo: nixpkgs
            basehead: cc455c004a60e1d65a0fb86ad6cc76168c6bb4d5...67c80531be622641b5b2ccc3a7aff355cb02476b
          - owner: nix-community
            repo: home-manager
            basehead: b0d769691cc379c9ab91d3acec5d14e75c02c02b...59be1f4983ee3689de3172716a6c7e95a6a37bb7
    steps:
      - uses: actions/checkout@v2
      - uses: ./
        with:
          owner: ${{ matrix.repo.owner }}
          repo: ${{ matrix.repo.repo }}
          basehead: ${{ matrix.repo.basehead }}
          token: ${{ secrets.GITHUB_TOKEN }}
          show-differences: ${{ matrix.show_differences }}
          show-merge-commits: ${{ matrix.show_merge_commits }}
  release:
    runs-on: ubuntu-latest
    concurrency: release
    needs: [build, test]
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
          persist-credentials: false
      - name: Setup NodeJS
        uses: actions/setup-node@v1
        with:
          node-version: 12
      - name: Install dependencies
        run: npm ci
      - name: Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx semantic-release
